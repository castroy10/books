<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление библиотекой</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div class="container">
    <h1 class="mb-4 text-center"><i class="bi bi-book fs-2"></i> Управление библиотекой</h1>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="authors-tab" data-bs-toggle="tab" data-bs-target="#authors"
                    type="button" role="tab">Авторы
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="genres-tab" data-bs-toggle="tab" data-bs-target="#genres" type="button"
                    role="tab">Жанры
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button"
                    role="tab">Книги
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade" id="authors" role="tabpanel">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-primary" onclick="openAuthorModal()">Добавить автора</button>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Имя</th>
                    <th>Год рождения</th>
                    <th>Национальность</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="authorsTableBody">
                </tbody>
            </table>
        </div>

        <div class="tab-pane fade" id="genres" role="tabpanel">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-primary" onclick="openGenreModal()">Добавить жанр</button>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Описание</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="genresTableBody">

                </tbody>
            </table>
        </div>

        <div class="tab-pane fade show active" id="books" role="tabpanel">
            <div class="d-flex justify-content-end mb-2">
                <button class="btn btn-primary" onclick="openBookModal()">Добавить книгу</button>
            </div>
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Год</th>
                    <th>ISBN</th>
                    <th>Автор</th>
                    <th>Жанр</th>
                    <th>Действия</th>
                </tr>
                </thead>
                <tbody id="booksTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="authorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorModalLabel">Автор</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="authorForm">
                    <input type="hidden" id="authorId">
                    <div class="mb-3">
                        <label for="authorName" class="form-label">Имя</label>
                        <input type="text" class="form-control" id="authorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="authorBirthYear" class="form-label">Год рождения</label>
                        <input type="number" class="form-control" id="authorBirthYear" max="2100">
                    </div>
                    <div class="mb-3">
                        <label for="authorNationality" class="form-label">Национальность</label>
                        <input type="text" class="form-control" id="authorNationality">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="saveAuthor()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="genreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="genreModalLabel">Жанр</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="genreForm">
                    <input type="hidden" id="genreId">
                    <div class="mb-3">
                        <label for="genreName" class="form-label">Название</label>
                        <input type="text" class="form-control" id="genreName" required>
                    </div>
                    <div class="mb-3">
                        <label for="genreDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="genreDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="saveGenre()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">Книга</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="mb-3">
                        <label for="bookTitle" class="form-label">Название</label>
                        <input type="text" class="form-control" id="bookTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="bookYear" class="form-label">Год публикации</label>
                        <input type="number" class="form-control" id="bookYear" max="2100">
                    </div>
                    <div class="mb-3">
                        <label for="bookIsbn" class="form-label">ISBN</label>
                        <input type="text" class="form-control" id="bookIsbn">
                    </div>
                    <div class="mb-3">
                        <label for="bookAuthor" class="form-label">Автор</label>
                        <select class="form-select" id="bookAuthor" required>

                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bookGenre" class="form-label">Жанр</label>
                        <select class="form-select" id="bookGenre" required>

                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="saveBook()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api';

    async function loadAuthors() {
        const response = await fetch(`${API_URL}/authors`);
        const authors = await response.json();
        const tbody = document.getElementById('authorsTableBody');
        tbody.innerHTML = '';
        authors.forEach(author => {
            tbody.innerHTML += `
                <tr>
                    <td>${author.id}</td>
                    <td>${author.name}</td>
                    <td>${author.birthYear || '-'}</td>
                    <td>${author.nationality || '-'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-warning" onclick="openAuthorModal(${author.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAuthor(${author.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    async function openAuthorModal(id = null) {
        const modal = new bootstrap.Modal(document.getElementById('authorModal'));
        document.getElementById('authorForm').reset();
        document.getElementById('authorId').value = '';
        document.getElementById('authorModalLabel').innerText = id ? 'Редактировать автора' : 'Добавить автора';

        if (id) {
            const response = await fetch(`${API_URL}/authors/${id}`);
            const author = await response.json();
            document.getElementById('authorId').value = author.id;
            document.getElementById('authorName').value = author.name;
            document.getElementById('authorBirthYear').value = author.birthYear;
            document.getElementById('authorNationality').value = author.nationality;
        }
        modal.show();
    }

    async function saveAuthor() {
        const id = document.getElementById('authorId').value;
        const author = {
            name: document.getElementById('authorName').value,
            birthYear: document.getElementById('authorBirthYear').value || null,
            nationality: document.getElementById('authorNationality').value
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/authors/${id}` : `${API_URL}/authors`;

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(author)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('authorModal')).hide();
            loadAuthors();
        } else {
            await showErrors(response);
        }
    }

    async function showErrors(response) {
        try {
            const errors = await response.json();
            let msg = 'Ошибка:\n';
            if (typeof errors === 'object') {
                for (const [key, value] of Object.entries(errors)) {
                    msg += `- ${value}\n`;
                }
            } else {
                msg += 'Неизвестная ошибка';
            }
            alert(msg);
        } catch (e) {
            alert('Произошла ошибка при обработке ответа сервера');
        }
    }

    async function deleteAuthor(id) {
        if (confirm('Are you sure?')) {
            await fetch(`${API_URL}/authors/${id}`, {method: 'DELETE'});
            loadAuthors();
        }
    }

    async function loadGenres() {
        const response = await fetch(`${API_URL}/genres`);
        const genres = await response.json();
        const tbody = document.getElementById('genresTableBody');
        tbody.innerHTML = '';
        genres.forEach(genre => {
            tbody.innerHTML += `
                <tr>
                    <td>${genre.id}</td>
                    <td>${genre.name}</td>
                    <td>${genre.description || '-'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-warning" onclick="openGenreModal(${genre.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteGenre(${genre.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    async function openGenreModal(id = null) {
        const modal = new bootstrap.Modal(document.getElementById('genreModal'));
        document.getElementById('genreForm').reset();
        document.getElementById('genreId').value = '';
        document.getElementById('genreModalLabel').innerText = id ? 'Редактировать жанр' : 'Добавить жанр';

        if (id) {
            const response = await fetch(`${API_URL}/genres/${id}`);
            const genre = await response.json();
            document.getElementById('genreId').value = genre.id;
            document.getElementById('genreName').value = genre.name;
            document.getElementById('genreDescription').value = genre.description;
        }
        modal.show();
    }

    async function saveGenre() {
        const id = document.getElementById('genreId').value;
        const genre = {
            name: document.getElementById('genreName').value,
            description: document.getElementById('genreDescription').value
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/genres/${id}` : `${API_URL}/genres`;

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(genre)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('genreModal')).hide();
            loadGenres();
        } else {
            await showErrors(response);
        }
    }

    async function deleteGenre(id) {
        if (confirm('Are you sure?')) {
            await fetch(`${API_URL}/genres/${id}`, {method: 'DELETE'});
            loadGenres();
        }
    }

    async function loadBooks() {
        const response = await fetch(`${API_URL}/books`);
        const books = await response.json();
        const tbody = document.getElementById('booksTableBody');
        tbody.innerHTML = '';
        books.forEach(book => {
            tbody.innerHTML += `
                <tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.publicationYear || '-'}</td>
                    <td>${book.isbn || '-'}</td>
                    <td>${book.authorName || 'Unknown'}</td>
                    <td>${book.genreName || 'Unknown'}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-warning" onclick="openBookModal(${book.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    }

    async function openBookModal(id = null) {
        const modal = new bootstrap.Modal(document.getElementById('bookModal'));
        document.getElementById('bookForm').reset();
        document.getElementById('bookId').value = '';
        document.getElementById('bookModalLabel').innerText = id ? 'Редактировать книгу' : 'Добавить книгу';

        const authorsRes = await fetch(`${API_URL}/authors`);
        const authors = await authorsRes.json();
        const authorSelect = document.getElementById('bookAuthor');
        authorSelect.innerHTML = '<option value="">Выберите автора</option>';
        authors.forEach(a => authorSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`);

        const genresRes = await fetch(`${API_URL}/genres`);
        const genres = await genresRes.json();
        const genreSelect = document.getElementById('bookGenre');
        genreSelect.innerHTML = '<option value="">Выберите жанр</option>';
        genres.forEach(g => genreSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`);

        if (id) {
            const response = await fetch(`${API_URL}/books/${id}`);
            const book = await response.json();
            document.getElementById('bookId').value = book.id;
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookYear').value = book.publicationYear;
            document.getElementById('bookIsbn').value = book.isbn;
            document.getElementById('bookAuthor').value = book.authorId;
            document.getElementById('bookGenre').value = book.genreId;
        }
        modal.show();
    }

    async function saveBook() {
        const id = document.getElementById('bookId').value;
        const book = {
            title: document.getElementById('bookTitle').value,
            publicationYear: document.getElementById('bookYear').value || null,
            isbn: document.getElementById('bookIsbn').value,
            authorId: document.getElementById('bookAuthor').value || null,
            genreId: document.getElementById('bookGenre').value || null
        };

        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/books/${id}` : `${API_URL}/books`;

        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(book)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('bookModal')).hide();
            loadBooks();
        } else {
            await showErrors(response);
        }
    }

    async function deleteBook(id) {
        if (confirm('Are you sure?')) {
            await fetch(`${API_URL}/books/${id}`, {method: 'DELETE'});
            loadBooks();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAuthors();
        loadGenres();
        loadBooks();
    });

</script>

</body>
<style>
    body {
        padding-top: 20px;
        background-color: #f8f9fa;
    }

    .container {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .nav-tabs {
        margin-bottom: 20px;
    }

    .table-actions {
        white-space: nowrap;
        width: 1%;
    }
</style>
</html>
